<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>H40N - N.ROOT | TERMINAL V3.3</title>

<style>
    body {
        background: #0a0a0a;
        margin: 0;
        padding: 0;
        font-family: monospace;
        color: #e5e5e5;
    }

    .terminal-wrapper {
        width: 90%;
        max-width: 900px;
        margin: 40px auto;
        border: 1px solid #333;
        border-radius: 8px;
        overflow: hidden;
        background: #111;
        box-shadow: 0px 0px 20px rgba(0,0,0,0.6);
        position: relative;
    }

    .terminal-header {
        background: #1a1a1a;
        padding: 10px;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .header-buttons {
        background: #1a1a1a;
        padding: 10px;
        border-bottom: 1px solid #333;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
    }

    .dot.red { background: #ff5f56; }
    .dot.yellow { background: #ffbd2e; }
    .dot.green { background: #27c93f; }

    .terminal-title {
        flex: 1;
        text-align: center;
        opacity: 0.7;
    }

    #output {
        height: 80vh;
        overflow-y: auto;
        padding: 15px;
        line-height: 1.45em;
        white-space: pre-wrap;
    }

    .terminal-input-area {
        display: flex;
        gap: 10px;
        padding: 12px;
        background: #1a1a1a;
        border-top: 1px solid #333;
    }

    #input {
        width: 100%;
        background: transparent;
        border: none;
        outline: none;
        color: #e5e5e5;
        font-size: 1em;
    }

    .cmd { color: #e5e5e5; }
    .out { color: #cccccc; }
    .error { color: #ff4d4d; }
    .success { color: #00e676; }
    .progress { color: #ffe100; }
    .note { color: #bdbdbd; opacity: 1; transition: opacity 0.6s; }
</style>
</head>

<body>

<div class="terminal-wrapper">

    <div class="terminal-header">
        <div class="dot red"></div>
        <div class="dot yellow"></div>
        <div class="dot green"></div>
        <div class="terminal-title">H40N - N.ROOT | TERMINAL V3.3</div>
    </div>

    <div id="output" aria-live="polite"></div>

    <div id="viewerOverlay" 
        style="
            display:none;
            position:absolute;
            top:0;
            left:0;
            width:100%;
            height:100%;
            z-index: 999;
            background: rgba(0,0,0,0.75);
            backdrop-filter: blur(3px);
        ">
        <div style="
            width:90%;
            height:85%;
            margin:40px auto 0 auto;
            background:#0a0a0a;
            border:1px solid #333;
            border-radius:12px;
            overflow:hidden;
            display:flex;
            flex-direction:column;
            box-shadow:0 0 20px rgba(0,0,0,0.7);
        ">
            <div class="header-buttons">
                <div class="dot red" onclick="closeViewer()"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
            </div>

            <iframe id="viewerFrame"
                    style="width:100%; height:100%; border:none; background:#0a0a0a;">
            </iframe>
        </div>
    </div>

    <div class="terminal-input-area">
        <span style="color:#00e676; font-weight:bold;">&gt;</span>
        <input id="input" type="text" autocomplete="off" placeholder="Digite um comando..." autofocus />
    </div>
</div>

<script>
/* -------------------------
   Vari√°veis principais
-------------------------*/
let commandHistory = [];
let historyIndex = -1;

const database = {
    users: [
        { id: 2, name: "ECH0", email: "ech0@h40n.sys", role: "user", password: "33#33", locked: true },
        { id: 3, name: "H40N", email: "h40n@h40n.sys", role: "user", password: "PR4G4#33" }
    ]
};

let loggedIn = false;
let currentUser = null;
const protectedCommands = ["status", "files"];
const output = document.getElementById("output");
const input = document.getElementById("input");

/* FILA PARA MENSAGENS */
let queue = [];
let processing = false;
let delayAfterProgress = false;

/* fun√ß√£o segura para logar erros JS no terminal */
function safeLogError(err) {
    try {
        const msg = (err && err.message) ? err.message : String(err);
        queueMessage("error", `[JS ERROR] ${msg}`, 5);
        console.error(err);
    } catch (e) {
        console.error("Erro ao logar erro:", e);
    }
}

/* Enfileira mensagens */
function queueMessage(type, text, speed = 20) {
    try {
        // prote√ß√£o contra valores inv√°lidos
        if (typeof text !== "string") text = String(text);
        queue.push({ type, text, speed });
        processQueue();
    } catch (err) {
        safeLogError(err);
    }
}

/* Processa fila com prote√ß√£o */
function processQueue() {
    if (processing || queue.length === 0) return;
    const job = queue.shift();
    if (!job) return;
    processing = true;

    const { type, text, speed } = job;
    let delay = 0;
    try {
        if (delayAfterProgress && type !== "progress") {
            delay = 3000;
            delayAfterProgress = false;
        }
        if (type === "progress") delayAfterProgress = true;

        setTimeout(() => {
            try {
                typeWrite(type, text, speed, () => {
                    processing = false;
                    // next tick para evitar callstack profundo
                    setTimeout(processQueue, 0);
                });
            } catch (err) {
                processing = false;
                safeLogError(err);
                setTimeout(processQueue, 0);
            }
        }, delay);
    } catch (err) {
        processing = false;
        safeLogError(err);
    }
}

/* wrapper para enfileirar (API p√∫blica) */
function print(type, text, speed = 20) {
    queueMessage(type, text, speed);
}

/* Digita√ß√£o letra-a-letra com prote√ß√µes */
function typeWrite(type, text, speed = 20, callback) {
    try {
        let i = 0;
        const line = document.createElement("div");
        line.className = type || "out";
        line.setAttribute("role", "log");
        output.appendChild(line);
        output.scrollTop = output.scrollHeight;

        function writeChar() {
            try {
                if (i <= text.length) {
                    line.textContent = text.slice(0, i);
                    output.scrollTop = output.scrollHeight;
                    i++;
                    // velocidade m√≠nima
                    const wait = Math.max(1, speed);
                    setTimeout(writeChar, wait);
                } else {
                    line.textContent = text; // garante linha completa
                    if (type === "note") {
                        // note fica vis√≠vel por 10s, depois some
                        setTimeout(() => {
                            try {
                                line.style.opacity = "0";
                                setTimeout(() => {
                                    if (line && line.parentNode) line.parentNode.removeChild(line);
                                }, 600);
                            } catch (e) { /* ignore */ }
                        }, 1000);
                    }
                    if (typeof callback === "function") callback();
                }
            } catch (err) {
                safeLogError(err);
                if (typeof callback === "function") callback();
            }
        }
        writeChar();
    } catch (err) {
        safeLogError(err);
        if (typeof callback === "function") callback();
    }
}

/* VIEWER */
function openFileInViewer(path) {
    try {
        const frame = document.getElementById("viewerFrame");
        const overlay = document.getElementById("viewerOverlay");
        frame.src = path;
        overlay.style.display = "block";

        // ARQUIVOS QUE DEVEM GERAR A MENSAGEM ESPECIAL
        if (path.includes("error403") || path.includes("node-n_error")) {
            print("error", "[FAILURE] MODULO RESTRITO::CORROMPIDO == ZONA DE MEM√ìRIA");
        } else {
            print("success", "Abertura bem-sucedida. Arquivo carregado no visualizador");
        }
        
    } catch (err) {
        safeLogError(err);
    }
}


function closeViewer() {
    try {
        const overlay = document.getElementById("viewerOverlay");
        const frame = document.getElementById("viewerFrame");
        overlay.style.display = "none";
        frame.src = "";
    } catch (err) {
        safeLogError(err);
    }
}

/* FILESYSTEM */
const fileSystem = {
    "arquivos.amanecer": {
        "relatorio-amanecer": "docs/amanecer_arq-relatorio.html",
        "experimento-amanecer": "docs/amanecer_arq-experimento.html"
    },
    "arquivos.kitsune": {
        "relatorio-yokai":"docs/kitsune_arq-relatorio.html",
        "anexos-yokai":"docs/kitsune_arq-anexos.html"
    },
    "arquivos.tpd-3": {
        "tpd-relatorio":"docs/node-n_error.html",
        "tpd-anexos":"docs/node-n_error.html",
        "arq-operador":"docs/node-n_root.html"
    },
    "anomaly": {
        "anomaly-index": "docs/error403.html",
        "noah_anchor": "docs/error403.html",
        "temporal_map": "docs/error403.html"
    },
    "moon": {
        "quantum_sys": "docs/error403.html",
        "node-n.root": "docs/node-n_root.html"
    },

    "usb.drive": {
    "log-usb": "docs/error403.html",
    "dump-bin": "docs/error403.html",
    "captura.raw": "docs/error403.html"
    },
};

/* COMANDOS */
function handleCommand(raw) {
    try {
        const cmd = (raw || "").trim();
        const lower = cmd.toLowerCase();
        if (!cmd) return;

        commandHistory.push(cmd);
        historyIndex = commandHistory.length;

        print("cmd", "/" + cmd);

        if (lower.startsWith("open ")) {
            const parts = cmd.split(" ").filter(Boolean);
            if (parts.length === 2) return handleOpen(parts[1].toLowerCase());
            if (parts.length === 3) {
                const folder = parts[1].toLowerCase();
                const file = parts[2].toLowerCase();
                if (!fileSystem[folder]) return print("error", `Pasta '${folder}' n√£o encontrada.`);
                if (!fileSystem[folder][file]) return print("error", `Arquivo '${file}' n√£o encontrado.`);
                return openFileInViewer(fileSystem[folder][file]);
            }
            return print("error", "Uso correto: open <pasta> ou open <pasta> <arquivo>");
        }

        if (protectedCommands.includes(lower) && !loggedIn)
            return print("error", "Acesso negado. Fa√ßa login.");

        if (lower === "help") {
            print("out", "=====================================================");
            print("out", "help                    - Lista comandos");
            print("out", "users                   - Lista usu√°rios");
            print("out", "login user senha        - Autentica√ß√£o");
            print("out", "files                   - Lista arquivos (requer login)");
            print("out", "open [pasta]            - Abre diret√≥rio (requer login)");
            print("out", "open [pasta] [arquivo]  - Abre diret√≥rio (requer login)");
            print("out", "logout                  - Encerrar sess√£o");
            print("note", "status operador");
            print("note", "status tpd-3");
            print("out", "=====================================================");
            return;
        }

        if (lower === "clear") {
            output.innerHTML = "";
            return;
        }

        if (lower === "users") {
            print("out", "=====================================================");
            database.users.forEach(u => {
                print("out", `[${u.role.toUpperCase()}] ${u.name} - ${u.email}`);
            });
            print("out", "=====================================================");
            return;
        }

        if (lower === "about") {
            print("out", "======================================");
            print("out", "Sistema criado por H40N em ##.09.20##");
            print("out", "======================================");
            return;
        }

        if (lower.startsWith("login ")) {
            const [_, user, ...passArray] = cmd.split(" ");
            const pass = passArray.join(" ");
            const found = database.users.find(
                u => u.name.toLowerCase() === (user || "").toLowerCase()
            );

            if (!found || found.password !== pass) {
                return print("error", "[FAILURE] LOGIN INV√ÅLIDO :: CREDENCIAIS INCORRETAS");
            }

            if (found.locked) {
                return print("error", "[BLOCK] Usuario bloqueado por viola√ß√£o de seguran√ßa.");
            }

            loggedIn = true;
            currentUser = found.name;
            print("success", `Login bem-sucedido. Bem-vindo, ${found.name}`);
            print("note", "m- sinto defini-ivam-t perdi-o");
            return;
        }

        if (lower === "logout") {
            if (!loggedIn) return print("error", "Nenhum usu√°rio logado.");
            loggedIn = false;
            currentUser = null;
            output.innerHTML = "";
            print("success", "Sess√£o encerrada.");
            print("out", "Digite 'help' para ver os comandos.");
            return;
        }

        if (lower === "status") {
            print("error", "[ERR_HANDLER] Assinatura corrompida");
            print("error", "[ERR_HANDLER] Operador instavel");
            return;
        }

        if (lower === "files") {
            if (currentUser === "ECH0") {
                print("out", "üìÅ anomaly");
                print("out", "üìÅ moon");
                return;
            }
            if (currentUser === "H40N") {
                print("out", "üìÅ arquivos.amanecer");
                print("out", "üìÅ arquivos.kitsune");
                print("out", "üìÅ arquivos.tpd-3");
                return;
            }
            return;
        }

        if (lower === "status tpd-3") {
            if (!loggedIn) return print("error", "Acesso negado. Fa√ßa login para continuar.");
            if (currentUser !== "H40N") return print("error", "Permiss√£o insuficiente");

            print("progress", "Localizando protocolo TPD-3...");
            print("progress", "Validando integridade do m√≥dulo...");
            print("progress", "Verificando assinatura de operador...");
            print("error", "[ERR_HANDLER::TPD3] Assinatura corrompida");
            print("error", "[ERR_HANDLER::TPD3] Operador n√£o encontrado");
            print("out", "");
            print("note", "ach- que estou me acostum-ndo com o vazio");
            return;
        }

        if (lower === "status operador") {
            if (!loggedIn) return print("error", "Acesso negado. Fa√ßa login para continuar.");
            if (currentUser !== "H40N") return print("error", "Permiss√£o insuficiente");

            print("progress", "Calculando integridade do operador...");
            print("out", "Frequ√™ncia card√≠aca :: INDETERMINADA");
            print("out", "Atividade neural :: OSCILANTE");
            print("out", "Integridade fisiol√≥gica :: DECRESCENTE [60%]");
            print("out", "Coer√™ncia de mem√≥ria :: INST√ÅVEL [40%]");
            print("out", "Presen√ßa f√≠sica :: DETECTADA EM M√öLTIPLOS ######");
            print("error", "Status geral :: VIVO | DESCALIBRADO | PRESO NA ZONA T-NULL");
            print("note", "isso n- fala sobre mim... fala?");
            return;
        }

    if (lower === "usb upload" || lower === "usb upload") {
        if (!loggedIn) return print("error", "Acesso negado. Fa√ßa login.");

        print("success", "Dispositivo detectado...");
        print("progress", "Inicializando leitura de diret√≥rio...");
        print("success", "Leitura conclu√≠da");

        setTimeout(() => {
            print("progress", "Copiando arquivos...");

            setTimeout(() => {
                print("success", "Upload conclu√≠do.");
                print("note", "por qu- voc- troux- isso pra c√°?");
            }, 1900);

        }, 1200);

        return;
    }

    // comando n√£o reconhecido
    print("error", `Comando n√£o reconhecido ou incorreto: '${cmd}'`);
    } catch (err) {
        safeLogError(err);
    }
} // <-- FECHAMENTO CORRETO DA handleCommand


function handleOpen(folder) {
    try {
        if (!loggedIn) return print("error", "Fa√ßa login.");
        if (!fileSystem[folder]) return print("error", `Pasta '${folder}' n√£o encontrada.`);
        print("progress", `Abrindo /${folder} ...`);
        Object.keys(fileSystem[folder]).forEach(f => print("out", " " + f));
    } catch (err) {
        safeLogError(err);
    }
}

/* INPUT: escuta tecla */
input.addEventListener("keydown", e => {
    try {
        if (e.key === "Enter") {
            e.preventDefault(); // prote√ß√£o extra
            const value = input.value;
            input.value = "";
            // roda o comando dentro de try/catch (dentro do handleCommand tamb√©m h√° try)
            handleCommand(value);
            return;
        }
        if (e.key === "ArrowUp") {
            if (historyIndex > 0) {
                historyIndex--;
                input.value = commandHistory[historyIndex] || "";
            }
            e.preventDefault();
            return;
        }
        if (e.key === "ArrowDown") {
            if (historyIndex < commandHistory.length - 1) {
                historyIndex++;
                input.value = commandHistory[historyIndex] || "";
            } else {
                historyIndex = commandHistory.length;
                input.value = "";
            }
            e.preventDefault();
            return;
        }
    } catch (err) {
        safeLogError(err);
    }
});

/* BOOT INICIAL */
print("progress", "Inicializando Terminal...");
print("success", "Conectado a H40N - N.ROOT");
print("out", "Digite 'help' para ver os comandos dispon√≠veis.");

/* captura erros globais e mostra no terminal, √∫til para debugar sem travar a UI */
window.addEventListener("error", (ev) => {
    safeLogError(ev.error || ev.message || "Erro desconhecido");
});
window.addEventListener("unhandledrejection", (ev) => {
    safeLogError(ev.reason || "Promise rejeitada sem handler");
});
</script>

</body>
</html>
